#!/bin/bash

# ã‚„ã‚“ã‚ã‚Šä¼è¨€ - èµ·å‹•ãƒ»ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ä½¿ç”¨æ–¹æ³•:
#   ./yanwari-start              - å…¨ç’°å¢ƒèµ·å‹•
#   ./yanwari-start restart      - Flutterã‚¢ãƒ—ãƒªã®ãƒ›ãƒƒãƒˆãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
#   ./yanwari-start reload       - Flutterã‚¢ãƒ—ãƒªã®ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰
#   ./yanwari-start stop         - å…¨ç’°å¢ƒåœæ­¢
#   ./yanwari-start status       - ç’°å¢ƒçŠ¶æ³ç¢ºèª

# è‰²ä»˜ãå‡ºåŠ›ç”¨ã®å®šç¾©
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
PROJECT_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Flutter ãƒ‘ã‚¹ã®è¨­å®š
export PATH="$PATH:/Users/fujinoyuki/development/flutter/bin"

# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼IDã‚’å–å¾—ã™ã‚‹é–¢æ•°
get_simulator_id() {
    # iPhone 16 Pro ã‚’å„ªå…ˆçš„ã«æ¢ã™
    SIMULATOR_ID=$(xcrun simctl list devices | grep "iPhone 16 Pro" | grep -v "unavailable" | head -1 | grep -oE "[A-F0-9-]{36}")
    
    # iPhone 16 Pro ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ä»–ã®iPhoneã‚’æ¢ã™
    if [ -z "$SIMULATOR_ID" ]; then
        SIMULATOR_ID=$(xcrun simctl list devices | grep -E "iPhone 1[4-6]" | grep -v "unavailable" | head -1 | grep -oE "[A-F0-9-]{36}")
    fi
    
    echo "$SIMULATOR_ID"
}

# Flutter ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹é–¢æ•°
find_flutter_process() {
    # Flutterãƒ—ãƒ­ã‚»ã‚¹ã‚’æ¢ã™ï¼ˆyanwari-messageãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å‹•ã„ã¦ã„ã‚‹ã‚‚ã®ï¼‰
    FLUTTER_PID=$(ps aux | grep "flutter run" | grep "yanwari-message" | grep -v grep | awk '{print $2}' | head -1)
    echo "$FLUTTER_PID"
}

# ãƒ›ãƒƒãƒˆãƒªã‚¹ã‚¿ãƒ¼ãƒˆæ©Ÿèƒ½
hot_restart() {
    echo -e "${CYAN}ğŸ”„ Flutterã‚¢ãƒ—ãƒªã®ãƒ›ãƒƒãƒˆãƒªã‚¹ã‚¿ãƒ¼ãƒˆå®Ÿè¡Œä¸­...${NC}"
    
    FLUTTER_PID=$(find_flutter_process)
    
    if [ -z "$FLUTTER_PID" ]; then
        echo -e "${RED}âŒ å‹•ä½œä¸­ã®Flutterãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}"
        echo "ã¾ãš './yanwari-start' ã§ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ãã ã•ã„"
        return 1
    fi
    
    # Flutterãƒ—ãƒ­ã‚»ã‚¹ã« 'R' (å¤§æ–‡å­—) ã‚’é€ä¿¡ã—ã¦ãƒ›ãƒƒãƒˆãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
    echo "R" | sudo -n tee /proc/$FLUTTER_PID/fd/0 2>/dev/null || {
        echo -e "${YELLOW}âš ï¸  ç›´æ¥å…¥åŠ›ãŒå¿…è¦ã§ã™ã€‚FlutterãŒå‹•ã„ã¦ã„ã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'R' ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„${NC}"
        
        # AppleScriptã§Flutterã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦Rã‚­ãƒ¼ã‚’é€ä¿¡
        osascript -e "
        tell application \"Terminal\"
            activate
            set targetWindow to first window whose name contains \"flutter run\"
            if targetWindow exists then
                do script \"\" in targetWindow
                delay 0.5
            end if
        end tell
        " 2>/dev/null || echo -e "${YELLOW}Flutterã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§æ‰‹å‹•ã§ 'R' ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„${NC}"
    }
    
    echo -e "${GREEN}âœ… ãƒ›ãƒƒãƒˆãƒªã‚¹ã‚¿ãƒ¼ãƒˆä¿¡å·ã‚’é€ä¿¡ã—ã¾ã—ãŸ${NC}"
    echo "æ•°ç§’å¾…ã£ã¦ã‹ã‚‰ã‚¢ãƒ—ãƒªãŒå†èµ·å‹•ã•ã‚Œã¾ã™"
}

# ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
hot_reload() {
    echo -e "${CYAN}âš¡ Flutterã‚¢ãƒ—ãƒªã®ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œä¸­...${NC}"
    
    FLUTTER_PID=$(find_flutter_process)
    
    if [ -z "$FLUTTER_PID" ]; then
        echo -e "${RED}âŒ å‹•ä½œä¸­ã®Flutterãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}"
        echo "ã¾ãš './yanwari-start' ã§ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ãã ã•ã„"
        return 1
    fi
    
    # Flutterãƒ—ãƒ­ã‚»ã‚¹ã« 'r' (å°æ–‡å­—) ã‚’é€ä¿¡ã—ã¦ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰
    echo "r" | sudo -n tee /proc/$FLUTTER_PID/fd/0 2>/dev/null || {
        echo -e "${YELLOW}âš ï¸  ç›´æ¥å…¥åŠ›ãŒå¿…è¦ã§ã™ã€‚FlutterãŒå‹•ã„ã¦ã„ã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'r' ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„${NC}"
        
        # AppleScriptã§Flutterã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦rã‚­ãƒ¼ã‚’é€ä¿¡
        osascript -e "
        tell application \"Terminal\"
            activate
            set targetWindow to first window whose name contains \"flutter run\"
            if targetWindow exists then
                do script \"\" in targetWindow
                delay 0.5
            end if
        end tell
        " 2>/dev/null || echo -e "${YELLOW}Flutterã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§æ‰‹å‹•ã§ 'r' ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„${NC}"
    }
    
    echo -e "${GREEN}âœ… ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ä¿¡å·ã‚’é€ä¿¡ã—ã¾ã—ãŸ${NC}"
    echo "å¤‰æ›´ãŒå³åº§ã«åæ˜ ã•ã‚Œã¾ã™"
}

# ç’°å¢ƒçŠ¶æ³ç¢ºèª
check_status() {
    echo -e "${BLUE}ğŸ“Š ã‚„ã‚“ã‚ã‚Šä¼è¨€ - ç’°å¢ƒçŠ¶æ³ç¢ºèª${NC}"
    echo "=================================="
    
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ç¢ºèª
    echo -e "\n${GREEN}1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼:${NC}"
    if curl -s http://localhost:8080/health > /dev/null 2>&1; then
        echo -e "  âœ… ${GREEN}èµ·å‹•ä¸­${NC} (http://localhost:8080)"
        curl -s http://localhost:8080/health | jq . 2>/dev/null || echo "  ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¿œç­”ã‚ã‚Š"
    else
        echo -e "  âŒ ${RED}åœæ­¢ä¸­${NC}"
    fi
    
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ç¢ºèª
    echo -e "\n${GREEN}2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼:${NC}"
    if lsof -i :5173 > /dev/null 2>&1; then
        echo -e "  âœ… ${GREEN}èµ·å‹•ä¸­${NC} (http://localhost:5173)"
    else
        echo -e "  âŒ ${RED}åœæ­¢ä¸­${NC}"
    fi
    
    # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ç¢ºèª
    echo -e "\n${GREEN}3. iOSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼:${NC}"
    SIMULATOR_ID=$(get_simulator_id)
    if [ -n "$SIMULATOR_ID" ]; then
        SIMULATOR_STATE=$(xcrun simctl list devices | grep "$SIMULATOR_ID" | grep -oE "\(.*\)" | tr -d "()")
        SIMULATOR_NAME=$(xcrun simctl list devices | grep "$SIMULATOR_ID" | cut -d'(' -f1 | xargs)
        
        if [ "$SIMULATOR_STATE" = "Booted" ]; then
            echo -e "  âœ… ${GREEN}èµ·å‹•ä¸­${NC} ($SIMULATOR_NAME)"
        else
            echo -e "  â¸ï¸  ${YELLOW}åœæ­¢ä¸­${NC} ($SIMULATOR_NAME)"
        fi
    else
        echo -e "  âŒ ${RED}åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ãªã—${NC}"
    fi
    
    # Flutterã‚¢ãƒ—ãƒªã®ç¢ºèª
    echo -e "\n${GREEN}4. Flutterã‚¢ãƒ—ãƒª:${NC}"
    FLUTTER_PID=$(find_flutter_process)
    if [ -n "$FLUTTER_PID" ]; then
        echo -e "  âœ… ${GREEN}èµ·å‹•ä¸­${NC} (PID: $FLUTTER_PID)"
        
        # ãƒ—ãƒ­ã‚»ã‚¹è©³ç´°
        FLUTTER_DETAILS=$(ps -p $FLUTTER_PID -o pid,cmd | tail -1)
        echo "  è©³ç´°: $FLUTTER_DETAILS"
    else
        echo -e "  âŒ ${RED}åœæ­¢ä¸­${NC}"
    fi
    
    echo -e "\n${BLUE}===================================="
    echo -e "ä½¿ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
    echo -e "  ./yanwari-start restart  # ãƒ›ãƒƒãƒˆãƒªã‚¹ã‚¿ãƒ¼ãƒˆ"
    echo -e "  ./yanwari-start reload   # ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰"
    echo -e "  ./yanwari-start stop     # å…¨ç’°å¢ƒåœæ­¢${NC}"
}

# å…¨ç’°å¢ƒåœæ­¢
stop_all() {
    echo -e "${RED}ğŸ›‘ ã‚„ã‚“ã‚ã‚Šä¼è¨€ - å…¨ç’°å¢ƒåœæ­¢ä¸­...${NC}"
    
    # Flutterã‚¢ãƒ—ãƒªã®åœæ­¢
    echo "1. Flutterã‚¢ãƒ—ãƒªã‚’åœæ­¢ä¸­..."
    FLUTTER_PID=$(find_flutter_process)
    if [ -n "$FLUTTER_PID" ]; then
        kill -TERM "$FLUTTER_PID" 2>/dev/null
        echo "  Flutterã‚¢ãƒ—ãƒªã‚’åœæ­¢ã—ã¾ã—ãŸ (PID: $FLUTTER_PID)"
    fi
    
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã®åœæ­¢
    echo "2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ä¸­..."
    BACKEND_PID=$(lsof -ti :8080)
    if [ -n "$BACKEND_PID" ]; then
        kill -TERM "$BACKEND_PID" 2>/dev/null
        echo "  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸ (PID: $BACKEND_PID)"
    fi
    
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã®åœæ­¢
    echo "3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ä¸­..."
    FRONTEND_PID=$(lsof -ti :5173)
    if [ -n "$FRONTEND_PID" ]; then
        kill -TERM "$FRONTEND_PID" 2>/dev/null
        echo "  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸ (PID: $FRONTEND_PID)"
    fi
    
    # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®åœæ­¢
    echo "4. iOSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’åœæ­¢ä¸­..."
    SIMULATOR_ID=$(get_simulator_id)
    if [ -n "$SIMULATOR_ID" ]; then
        xcrun simctl shutdown "$SIMULATOR_ID" 2>/dev/null
        echo "  ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸ"
    fi
    
    echo -e "${GREEN}âœ… å…¨ç’°å¢ƒã®åœæ­¢ãŒå®Œäº†ã—ã¾ã—ãŸ${NC}"
}

# å…¨ç’°å¢ƒèµ·å‹•ï¼ˆæ—¢å­˜ã®start-all.shã®å†…å®¹ã‚’ãƒ™ãƒ¼ã‚¹ã«ï¼‰
start_all() {
    echo -e "${BLUE}ğŸš€ ã‚„ã‚“ã‚ã‚Šä¼è¨€ - å…¨ç’°å¢ƒèµ·å‹•é–‹å§‹${NC}"
    echo "=================================="

    # 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
    echo -e "\n${GREEN}1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ä¸­...${NC}"
    cd "$PROJECT_ROOT/backend"

    # æ—¢å­˜ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèª
    if lsof -i :8080 > /dev/null 2>&1; then
        echo -e "${YELLOW}âš ï¸  ãƒãƒ¼ãƒˆ8080ã¯æ—¢ã«ä½¿ç”¨ä¸­ã§ã™${NC}"
        echo "æ—¢å­˜ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™"
    else
        # å®Œå…¨ãªã‚„ã‚“ã‚ã‚Šä¼è¨€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•
        osascript -e "tell app \"Terminal\" to do script \"cd '$PROJECT_ROOT/backend' && ./yanwari-message-backend\""
        echo "å®Œå…¨ãªã‚„ã‚“ã‚ã‚Šä¼è¨€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§èµ·å‹•ã—ã¾ã—ãŸ"
        echo "èµ·å‹•å¾…æ©Ÿä¸­..."
        sleep 8
    fi

    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®èµ·å‹•ç¢ºèª
    echo -n "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’ç¢ºèªä¸­"
    for i in {1..15}; do
        if curl -s http://localhost:8080/health > /dev/null 2>&1; then
            echo -e "\n${GREEN}âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å®Œäº† (http://localhost:8080)${NC}"
            break
        fi
        echo -n "."
        sleep 2
    done

    # 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
    echo -e "\n${GREEN}2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ä¸­...${NC}"
    cd "$PROJECT_ROOT/frontend"

    # æ—¢å­˜ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèª
    if lsof -i :5173 > /dev/null 2>&1; then
        echo -e "${YELLOW}âš ï¸  ãƒãƒ¼ãƒˆ5173ã¯æ—¢ã«ä½¿ç”¨ä¸­ã§ã™${NC}"
        echo "æ—¢å­˜ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™"
    else
        # æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•
        osascript -e "tell app \"Terminal\" to do script \"cd '$PROJECT_ROOT/frontend' && npm run dev\""
        echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã‚’æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§èµ·å‹•ã—ã¾ã—ãŸ"
        echo "èµ·å‹•å¾…æ©Ÿä¸­..."
        sleep 5
    fi

    # 3. iOSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®èµ·å‹•
    echo -e "\n${GREEN}3. iOSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼èµ·å‹•ä¸­...${NC}"

    SIMULATOR_ID=$(get_simulator_id)

    if [ -z "$SIMULATOR_ID" ]; then
        echo -e "${RED}âŒ iPhoneã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}"
    else
        # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª
        SIMULATOR_STATE=$(xcrun simctl list devices | grep "$SIMULATOR_ID" | grep -oE "\(.*\)" | tr -d "()")
        
        if [ "$SIMULATOR_STATE" = "Booted" ]; then
            echo -e "${YELLOW}âš ï¸  ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯æ—¢ã«èµ·å‹•ã—ã¦ã„ã¾ã™${NC}"
        else
            xcrun simctl boot "$SIMULATOR_ID"
            echo "ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ"
            # Simulator.appã‚’é–‹ã
            open -a Simulator
            sleep 3
        fi
        
        echo -e "${GREEN}âœ… iOSã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼èµ·å‹•å®Œäº†${NC}"
    fi

    # 4. Flutterã‚¢ãƒ—ãƒªã®èµ·å‹•
    echo -e "\n${GREEN}4. Flutterãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªèµ·å‹•ä¸­...${NC}"
    cd "$PROJECT_ROOT/mobile"

    # ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
    if [ ! -d "ios/Pods" ]; then
        echo "ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        flutter pub get
    fi

    # æ—¢å­˜ã®Flutterãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¢ºèª
    FLUTTER_PID=$(find_flutter_process)
    if [ -n "$FLUTTER_PID" ]; then
        echo -e "${YELLOW}âš ï¸  Flutterã‚¢ãƒ—ãƒªã¯æ—¢ã«èµ·å‹•ä¸­ã§ã™ (PID: $FLUTTER_PID)${NC}"
        echo "ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯: ./yanwari-start reload"
    else
        # Flutterã‚¢ãƒ—ãƒªã‚’èµ·å‹•
        if [ -n "$SIMULATOR_ID" ]; then
            # æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§Flutterã‚’èµ·å‹•
            osascript -e "tell app \"Terminal\" to do script \"cd '$PROJECT_ROOT/mobile' && export PATH=\\\$PATH:/Users/fujinoyuki/development/flutter/bin && flutter run -d $SIMULATOR_ID\""
            echo "Flutterã‚¢ãƒ—ãƒªã‚’æ–°ã—ã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§èµ·å‹•ã—ã¾ã—ãŸ"
        else
            echo -e "${YELLOW}âš ï¸  ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€Webãƒ–ãƒ©ã‚¦ã‚¶ã§èµ·å‹•ã—ã¾ã™${NC}"
            osascript -e "tell app \"Terminal\" to do script \"cd '$PROJECT_ROOT/mobile' && export PATH=\\\$PATH:/Users/fujinoyuki/development/flutter/bin && flutter run -d chrome --web-port 3000\""
        fi
    fi

    # 5. èµ·å‹•å®Œäº†ã‚µãƒãƒªãƒ¼
    echo -e "\n${BLUE}=================================="
    echo -e "ğŸ‰ ã‚„ã‚“ã‚ã‚Šä¼è¨€ - å…¨ç’°å¢ƒèµ·å‹•å®Œäº†ï¼"
    echo -e "==================================${NC}"
    echo
    echo -e "${GREEN}ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªURL:${NC}"
    echo -e "  ğŸ“¡ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API: ${BLUE}http://localhost:8080${NC}"
    echo -e "  ğŸ–¥ï¸  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ${BLUE}http://localhost:5173${NC}"
    echo -e "  ğŸ“± ãƒ¢ãƒã‚¤ãƒ«(Webç‰ˆ): ${BLUE}http://localhost:3000${NC}"
    echo
    echo -e "${YELLOW}ä¾¿åˆ©ãªã‚³ãƒãƒ³ãƒ‰:${NC}"
    echo -e "  ./yanwari-start status   # ç’°å¢ƒçŠ¶æ³ç¢ºèª"
    echo -e "  ./yanwari-start restart  # Flutterãƒ›ãƒƒãƒˆãƒªã‚¹ã‚¿ãƒ¼ãƒˆ"
    echo -e "  ./yanwari-start reload   # Flutterãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰"
    echo -e "  ./yanwari-start stop     # å…¨ç’°å¢ƒåœæ­¢"
    echo
    echo -e "${GREEN}Happy Coding! ğŸš€${NC}"

    # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯URL
    echo -e "\n${BLUE}å‹•ä½œç¢ºèªç”¨ã‚³ãƒãƒ³ãƒ‰:${NC}"
    echo "  curl http://localhost:8080/health  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"
    echo "  open http://localhost:5173         # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’é–‹ã"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
case "${1:-start}" in
    "restart"|"r")
        hot_restart
        ;;
    "reload"|"hot"|"h")
        hot_reload
        ;;
    "status"|"s")
        check_status
        ;;
    "stop"|"quit"|"q")
        stop_all
        ;;
    "start"|"")
        start_all
        ;;
    *)
        echo -e "${BLUE}ğŸ”§ ã‚„ã‚“ã‚ã‚Šä¼è¨€ - èµ·å‹•ãƒ»ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ${NC}"
        echo
        echo "ä½¿ç”¨æ–¹æ³•:"
        echo -e "  ${GREEN}./yanwari-start${NC}          # å…¨ç’°å¢ƒèµ·å‹•"
        echo -e "  ${GREEN}./yanwari-start restart${NC}  # Flutterãƒ›ãƒƒãƒˆãƒªã‚¹ã‚¿ãƒ¼ãƒˆ"
        echo -e "  ${GREEN}./yanwari-start reload${NC}   # Flutterãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰"
        echo -e "  ${GREEN}./yanwari-start status${NC}   # ç’°å¢ƒçŠ¶æ³ç¢ºèª"
        echo -e "  ${GREEN}./yanwari-start stop${NC}     # å…¨ç’°å¢ƒåœæ­¢"
        echo
        echo "çŸ­ç¸®å½¢:"
        echo -e "  ${CYAN}./yanwari-start r${NC}        # restart"
        echo -e "  ${CYAN}./yanwari-start h${NC}        # reload (hot reload)"
        echo -e "  ${CYAN}./yanwari-start s${NC}        # status"
        echo -e "  ${CYAN}./yanwari-start q${NC}        # stop (quit)"
        ;;
esac