<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWTèªè¨¼ãƒ†ã‚¹ãƒˆ - ã‚„ã‚“ã‚ã‚Šä¼è¨€</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        h2 {
            color: #666;
            font-size: 18px;
            margin-bottom: 15px;
        }
        input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.secondary:hover {
            background-color: #0b7dda;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #da190b;
        }
        .response {
            margin-top: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        .token-display {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            word-break: break-all;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” JWTèªè¨¼ãƒ†ã‚¹ãƒˆ</h1>
        
        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² -->
        <div class="section">
            <h2>1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h2>
            <input type="text" id="registerName" placeholder="åå‰" value="ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼">
            <input type="email" id="registerEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" value="newuser@example.com">
            <input type="password" id="registerPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰" value="password123">
            <button onclick="register()">ç™»éŒ²</button>
            <div id="registerResponse" class="response"></div>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
        <div class="section">
            <h2>2. ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <input type="email" id="loginEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" value="alice@yanwari-message.com">
            <input type="password" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" value="password123">
            <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button class="secondary" onclick="loginAsAlice()">Aliceã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button class="secondary" onclick="loginAsBob()">Bobã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="loginResponse" class="response"></div>
        </div>

        <!-- ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ç¤º -->
        <div class="section">
            <h2>3. ç¾åœ¨ã®ãƒˆãƒ¼ã‚¯ãƒ³</h2>
            <div>
                <strong>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³:</strong>
                <div id="accessToken" class="token-display">æœªå–å¾—</div>
            </div>
            <div style="margin-top: 10px;">
                <strong>ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³:</strong>
                <div id="refreshToken" class="token-display">æœªå–å¾—</div>
            </div>
            <button class="secondary" onclick="refreshTokens()">ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°</button>
            <button class="danger" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            <div id="tokenResponse" class="response"></div>
        </div>

        <!-- API ãƒ†ã‚¹ãƒˆ -->
        <div class="section">
            <h2>4. èªè¨¼ãŒå¿…è¦ãªAPIãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="testProtectedAPI('/api/v1/users/me')">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—</button>
            <button onclick="testProtectedAPI('/api/v1/messages')">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§å–å¾—</button>
            <button onclick="testProtectedAPI('/api/v1/settings')">è¨­å®šå–å¾—</button>
            <button onclick="testProtectedAPI('/api/v1/users/search?q=alice&limit=3')">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢</button>
            <button onclick="testProtectedAPI('/api/v1/friends')">å‹é”ä¸€è¦§</button>
            <div id="apiResponse" class="response"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        let currentAccessToken = '';
        let currentRefreshToken = '';

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
        async function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await response.json();
                const responseDiv = document.getElementById('registerResponse');
                
                if (response.ok) {
                    responseDiv.className = 'response success';
                    responseDiv.textContent = 'âœ… ç™»éŒ²æˆåŠŸ\n' + JSON.stringify(data, null, 2);
                    
                    // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
                    if (data.data) {
                        currentAccessToken = data.data.access_token;
                        currentRefreshToken = data.data.refresh_token;
                        updateTokenDisplay();
                    }
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = 'âŒ ç™»éŒ²å¤±æ•—\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                document.getElementById('registerResponse').className = 'response error';
                document.getElementById('registerResponse').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                const responseDiv = document.getElementById('loginResponse');
                
                if (response.ok) {
                    responseDiv.className = 'response success';
                    responseDiv.textContent = 'âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ\n' + JSON.stringify(data, null, 2);
                    
                    // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
                    if (data.data) {
                        currentAccessToken = data.data.access_token;
                        currentRefreshToken = data.data.refresh_token;
                        updateTokenDisplay();
                    }
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = 'âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                document.getElementById('loginResponse').className = 'response error';
                document.getElementById('loginResponse').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°
        async function refreshTokens() {
            if (!currentRefreshToken) {
                alert('ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ refresh_token: currentRefreshToken })
                });

                const data = await response.json();
                const responseDiv = document.getElementById('tokenResponse');
                
                if (response.ok) {
                    responseDiv.className = 'response success';
                    responseDiv.textContent = 'âœ… ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°æˆåŠŸ\n' + JSON.stringify(data, null, 2);
                    
                    // æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
                    if (data.data) {
                        currentAccessToken = data.data.access_token;
                        currentRefreshToken = data.data.refresh_token;
                        updateTokenDisplay();
                    }
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°å¤±æ•—\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                document.getElementById('tokenResponse').className = 'response error';
                document.getElementById('tokenResponse').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function logout() {
            if (!currentAccessToken) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentAccessToken}`,
                    }
                });

                const data = await response.json();
                const responseDiv = document.getElementById('tokenResponse');
                
                if (response.ok) {
                    responseDiv.className = 'response success';
                    responseDiv.textContent = 'âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ\n' + JSON.stringify(data, null, 2);
                    
                    // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢
                    currentAccessToken = '';
                    currentRefreshToken = '';
                    updateTokenDisplay();
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = 'âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                document.getElementById('tokenResponse').className = 'response error';
                document.getElementById('tokenResponse').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
        }

        // ä¿è­·ã•ã‚ŒãŸAPIã®ãƒ†ã‚¹ãƒˆ
        async function testProtectedAPI(endpoint) {
            if (!currentAccessToken) {
                alert('ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${currentAccessToken}`,
                    }
                });

                const data = await response.json();
                const responseDiv = document.getElementById('apiResponse');
                
                if (response.ok) {
                    responseDiv.className = 'response success';
                    responseDiv.textContent = `âœ… ${endpoint} æˆåŠŸ\n` + JSON.stringify(data, null, 2);
                } else {
                    responseDiv.className = 'response error';
                    responseDiv.textContent = `âŒ ${endpoint} å¤±æ•—\n` + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                document.getElementById('apiResponse').className = 'response error';
                document.getElementById('apiResponse').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³è¡¨ç¤ºæ›´æ–°
        function updateTokenDisplay() {
            document.getElementById('accessToken').textContent = currentAccessToken || 'æœªå–å¾—';
            document.getElementById('refreshToken').textContent = currentRefreshToken || 'æœªå–å¾—';
        }

        // ã‚·ãƒ¼ãƒ€ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®ã‚¯ã‚¤ãƒƒã‚¯ãƒ­ã‚°ã‚¤ãƒ³
        async function loginAsAlice() {
            document.getElementById('loginEmail').value = 'alice@yanwari-message.com';
            document.getElementById('loginPassword').value = 'password123';
            await login();
        }

        async function loginAsBob() {
            document.getElementById('loginEmail').value = 'bob@yanwari-message.com';
            document.getElementById('loginPassword').value = 'password123';
            await login();
        }
    </script>
</body>
</html>