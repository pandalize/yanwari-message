name: Team Metrics Collection

on:
  schedule:
    # æ¯æ—¥æœ8æ™‚ã¨å¤•æ–¹6æ™‚ã«å®Ÿè¡Œ (JST)
    - cron: '0 23 * * *'  # æœ8æ™‚ JST (UTC 23æ™‚å‰æ—¥)
    - cron: '0 9 * * *'   # å¤•æ–¹6æ™‚ JST (UTC 9æ™‚)
  workflow_dispatch:

jobs:
  collect-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create metrics directory
        run: mkdir -p docs/metrics

      - name: Collect team metrics
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            console.log('Collecting team metrics...');
            
            // ç¾åœ¨ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å–å¾—
            const milestones = await github.rest.issues.listMilestones({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'due_on',
              direction: 'asc'
            });
            
            if (milestones.data.length === 0) {
              console.log('No active milestones found');
              return;
            }
            
            const currentMilestone = milestones.data[0];
            
            // Issueså–å¾—
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              milestone: currentMilestone.number,
              state: 'all',
              per_page: 100
            });
            
            // Pull Requestså–å¾—
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });
            
            // Collaboratorså–å¾—
            const collaborators = await github.rest.repos.listCollaborators({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨ˆç®—
            const today = new Date().toISOString().split('T')[0];
            
            // åŸºæœ¬çµ±è¨ˆ
            const totalIssues = issues.data.length;
            const openIssues = issues.data.filter(i => i.state === 'open').length;
            const closedIssues = issues.data.filter(i => i.state === 'closed').length;
            
            // Story Pointsè¨ˆç®—
            const totalPoints = issues.data.reduce((sum, issue) => {
              const estimateLabel = issue.labels.find(label => 
                label.name.startsWith('estimate/')
              );
              return sum + (estimateLabel ? parseInt(estimateLabel.name.split('/')[1]) : 0);
            }, 0);
            
            const completedPoints = issues.data
              .filter(issue => issue.state === 'closed')
              .reduce((sum, issue) => {
                const estimateLabel = issue.labels.find(label => 
                  label.name.startsWith('estimate/')
                );
                return sum + (estimateLabel ? parseInt(estimateLabel.name.split('/')[1]) : 0);
              }, 0);
            
            // æ‹…å½“è€…åˆ¥çµ±è¨ˆ
            const assigneeStats = {};
            issues.data.forEach(issue => {
              if (issue.assignee) {
                const login = issue.assignee.login;
                if (!assigneeStats[login]) {
                  assigneeStats[login] = {
                    name: issue.assignee.login,
                    avatar_url: issue.assignee.avatar_url,
                    total_issues: 0,
                    open_issues: 0,
                    closed_issues: 0,
                    total_points: 0,
                    completed_points: 0
                  };
                }
                
                assigneeStats[login].total_issues++;
                if (issue.state === 'open') {
                  assigneeStats[login].open_issues++;
                } else {
                  assigneeStats[login].closed_issues++;
                }
                
                const estimateLabel = issue.labels.find(label => 
                  label.name.startsWith('estimate/')
                );
                const points = estimateLabel ? parseInt(estimateLabel.name.split('/')[1]) : 0;
                assigneeStats[login].total_points += points;
                if (issue.state === 'closed') {
                  assigneeStats[login].completed_points += points;
                }
              }
            });
            
            // é€±åˆ¥é€²æ—è¨ˆç®—ï¼ˆéå»4é€±é–“ï¼‰
            const weeklyProgress = [];
            for (let i = 3; i >= 0; i--) {
              const weekStart = new Date();
              weekStart.setDate(weekStart.getDate() - (i * 7 + 7));
              const weekEnd = new Date();
              weekEnd.setDate(weekEnd.getDate() - (i * 7));
              
              const weekIssues = issues.data.filter(issue => {
                if (!issue.closed_at) return false;
                const closedDate = new Date(issue.closed_at);
                return closedDate >= weekStart && closedDate <= weekEnd;
              });
              
              const weekPoints = weekIssues.reduce((sum, issue) => {
                const estimateLabel = issue.labels.find(label => 
                  label.name.startsWith('estimate/')
                );
                return sum + (estimateLabel ? parseInt(estimateLabel.name.split('/')[1]) : 0);
              }, 0);
              
              weeklyProgress.push({
                week: `${weekStart.getMonth() + 1}/${weekStart.getDate()}`,
                issues_completed: weekIssues.length,
                points_completed: weekPoints
              });
            }
            
            // Issue typeåˆ¥çµ±è¨ˆ
            const typeStats = {
              feature: { count: 0, points: 0 },
              bug: { count: 0, points: 0 },
              task: { count: 0, points: 0 },
              epic: { count: 0, points: 0 }
            };
            
            issues.data.forEach(issue => {
              const typeLabel = issue.labels.find(label => 
                label.name.startsWith('type/')
              );
              const estimateLabel = issue.labels.find(label => 
                label.name.startsWith('estimate/')
              );
              const points = estimateLabel ? parseInt(estimateLabel.name.split('/')[1]) : 0;
              
              if (typeLabel) {
                const type = typeLabel.name.split('/')[1];
                if (typeStats[type]) {
                  typeStats[type].count++;
                  typeStats[type].points += points;
                }
              }
            });
            
            // ãƒ™ãƒ­ã‚·ãƒ†ã‚£è¨ˆç®—
            const velocity = weeklyProgress.length > 0 ? 
              weeklyProgress.reduce((sum, week) => sum + week.points_completed, 0) / weeklyProgress.length : 0;
            
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            const metrics = {
              collected_at: new Date().toISOString(),
              milestone: {
                number: currentMilestone.number,
                title: currentMilestone.title,
                due_on: currentMilestone.due_on,
                open_issues: currentMilestone.open_issues,
                closed_issues: currentMilestone.closed_issues
              },
              sprint_summary: {
                total_issues: totalIssues,
                open_issues: openIssues,
                closed_issues: closedIssues,
                completion_rate: totalIssues > 0 ? Math.round((closedIssues / totalIssues) * 100) : 0,
                total_points: totalPoints,
                completed_points: completedPoints,
                remaining_points: totalPoints - completedPoints,
                points_completion_rate: totalPoints > 0 ? Math.round((completedPoints / totalPoints) * 100) : 0
              },
              team_stats: {
                total_members: Object.keys(assigneeStats).length,
                average_velocity: velocity,
                assignee_breakdown: Object.values(assigneeStats)
              },
              weekly_progress: weeklyProgress,
              type_breakdown: typeStats,
              pull_requests: {
                total: prs.data.length,
                open: prs.data.filter(pr => pr.state === 'open').length,
                merged: prs.data.filter(pr => pr.merged_at).length
              }
            };
            
            // JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            const metricsPath = `docs/metrics/team-metrics-${today}.json`;
            fs.writeFileSync(metricsPath, JSON.stringify(metrics, null, 2));
            
            // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®ãƒªãƒ³ã‚¯æ›´æ–°
            fs.writeFileSync('docs/metrics/latest.json', JSON.stringify(metrics, null, 2));
            
            console.log(`Team metrics collected and saved to ${metricsPath}`);
            console.log(`Sprint: ${currentMilestone.title}`);
            console.log(`Completion: ${metrics.sprint_summary.completion_rate}% (${closedIssues}/${totalIssues} issues)`);
            console.log(`Points: ${completedPoints}/${totalPoints} (${metrics.sprint_summary.points_completion_rate}%)`);
            console.log(`Team velocity: ${velocity.toFixed(1)} points/week`);

      - name: Generate team dashboard
        run: |
          # Update team dashboard navigation
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>pandalize Team - Agile Dashboard</title>
              <style>
                  body { 
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
                      margin: 0;
                      padding: 20px;
                      background-color: #f6f8fa;
                  }
                  .container { 
                      max-width: 800px; 
                      margin: 0 auto; 
                      background: white;
                      padding: 40px;
                      border-radius: 8px;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  }
                  .header {
                      text-align: center;
                      margin-bottom: 40px;
                  }
                  .header h1 {
                      margin: 0 0 8px 0;
                      color: #24292f;
                      font-size: 2.5em;
                  }
                  .header p {
                      color: #656d76;
                      font-size: 1.1em;
                      margin: 0;
                  }
                  .nav-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                      gap: 20px;
                      margin: 30px 0;
                  }
                  .nav-card {
                      background: #f6f8fa;
                      border: 1px solid #d0d7de;
                      border-radius: 8px;
                      padding: 24px;
                      text-decoration: none;
                      color: inherit;
                      transition: all 0.2s ease;
                  }
                  .nav-card:hover {
                      background: #fff;
                      border-color: #0969da;
                      transform: translateY(-2px);
                      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                  }
                  .nav-card h3 {
                      margin: 0 0 12px 0;
                      color: #0969da;
                      font-size: 1.3em;
                  }
                  .nav-card p {
                      margin: 0;
                      color: #656d76;
                      line-height: 1.5;
                  }
                  .quick-links {
                      background: #fff8c5;
                      border: 1px solid #d4a72c;
                      border-radius: 6px;
                      padding: 20px;
                      margin: 30px 0;
                  }
                  .quick-links h3 {
                      margin: 0 0 16px 0;
                      color: #9a6700;
                  }
                  .quick-links ul {
                      margin: 0;
                      padding-left: 20px;
                  }
                  .quick-links li {
                      margin: 8px 0;
                  }
                  .quick-links a {
                      color: #9a6700;
                      text-decoration: none;
                  }
                  .quick-links a:hover {
                      text-decoration: underline;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸš€ pandalize Team</h1>
                      <p>Agile Development Dashboard</p>
                  </div>
                  
                  <div class="nav-grid">
                      <a href="team-dashboard/" class="nav-card">
                          <h3>ğŸ‘¥ Team Dashboard</h3>
                          <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ¼ãƒ çŠ¶æ³ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»é€²æ—æ¦‚è¦</p>
                      </a>
                      
                      <a href="burndown/" class="nav-card">
                          <h3>ğŸ“Š Burndown Charts</h3>
                          <p>ã‚¹ãƒ—ãƒªãƒ³ãƒˆé€²æ—ã®å¯è¦–åŒ–ã¨ãƒ™ãƒ­ã‚·ãƒ†ã‚£åˆ†æ</p>
                      </a>
                      
                      <a href="https://github.com/pandalize/agile/issues" class="nav-card">
                          <h3>ğŸ“‹ Issues</h3>
                          <p>ã‚¿ã‚¹ã‚¯ç®¡ç†ã€ãƒã‚°ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã€User Storyç®¡ç†</p>
                      </a>
                      
                      <a href="https://github.com/pandalize/agile/projects" class="nav-card">
                          <h3>ğŸƒâ€â™‚ï¸ Project Board</h3>
                          <p>ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰ã§ã®ã‚¹ãƒ—ãƒªãƒ³ãƒˆç®¡ç†</p>
                      </a>
                      
                      <a href="https://github.com/pandalize/agile/milestones" class="nav-card">
                          <h3>ğŸ¯ Milestones</h3>
                          <p>ã‚¹ãƒ—ãƒªãƒ³ãƒˆè¨ˆç”»ã¨æœŸé™ç®¡ç†</p>
                      </a>
                      
                      <a href="https://github.com/pandalize/agile/actions" class="nav-card">
                          <h3>âš™ï¸ Actions</h3>
                          <p>è‡ªå‹•åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†çŠ¶æ³</p>
                      </a>
                  </div>
                  
                  <div class="quick-links">
                      <h3>ğŸ”— Quick Links</h3>
                      <ul>
                          <li><a href="https://github.com/pandalize/agile">ğŸ“ GitHub Repository</a></li>
                          <li><a href="https://github.com/pandalize/agile/discussions">ğŸ’¬ Discussions</a></li>
                          <li><a href="https://github.com/pandalize/agile/wiki">ğŸ“– Documentation</a></li>
                          <li><a href="https://github.com/pandalize/agile/releases">ğŸš€ Releases</a></li>
                      </ul>
                  </div>
                  
                  <div style="text-align: center; color: #656d76; font-size: 0.9em; margin-top: 40px;">
                      <p>Powered by GitHub Projects v2 + GitHub Actions + GitHub Pages</p>
                      <p>Last updated: $(date)</p>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/
          git diff --staged --quiet || git commit -m "ğŸ“ˆ Update team metrics and dashboard

          ğŸ“Š Metrics collected: $(date)
          ğŸ¯ Sprint progress and team statistics updated
          ğŸ‘¥ Team dashboard refreshed with latest data

          ğŸ¤– Generated with GitHub Actions"
          git push